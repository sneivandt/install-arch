name: CI

on:
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  shellcheck:
    name: ShellCheck Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: '.'
          format: gcc
          severity: warning

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Make test scripts executable
        run: chmod +x tests/*.sh
      
      - name: Run unit tests
        run: ./tests/unit_tests.sh
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: |
            tests/*.log
          retention-days: 7

  integration-test:
    name: Docker Integration Test
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
      options: --privileged
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      
      - name: Update system and install dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm shellcheck dialog git curl lvm2 cryptsetup \
            parted e2fsprogs dosfstools util-linux
      
      - name: Make scripts executable
        run: chmod +x tests/*.sh install-arch.sh
      
      - name: Run integration test
        run: ./tests/integration_test.sh
      
      - name: Upload integration test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-logs
          path: |
            *.log
            /tmp/test-*.log
          retention-days: 7

  test-script:
    name: Test Script on Arch Linux
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Update system and install dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm shellcheck dialog git curl lvm2 cryptsetup parted
      
      - name: Run shellcheck on install-arch.sh
        run: shellcheck install-arch.sh
      
      - name: Verify script syntax
        run: bash -n install-arch.sh
      
      - name: Check for required commands
        run: |
          echo "Checking for required commands in script..."
          grep -E 'pacman|dialog|fdisk|cryptsetup|lvcreate|arch-chroot' install-arch.sh
      
      - name: Verify file permissions
        run: |
          if [ ! -x install-arch.sh ]; then
            echo "Error: install-arch.sh is not executable"
            exit 1
          fi
          echo "install-arch.sh is executable"
      
      - name: Test help/usage patterns
        run: |
          # Verify the script doesn't error on basic invocations (it will fail on dialog, which is expected)
          bash -n install-arch.sh && echo "Script syntax is valid"
      
      - name: Test --dry-run and --test-mode flags
        run: |
          echo "Testing command line arguments..."
          # Test invalid argument
          if ./install-arch.sh --invalid-flag 2>&1 | grep -q "Unknown option"; then
            echo "✓ Invalid flag correctly rejected"
          else
            echo "✗ Invalid flag handling failed"
            exit 1
          fi
          # Test that the script accepts valid flags and runs to completion in dry-run
          export TEST_MODE_MODE="1" TEST_MODE_HOSTNAME="test" TEST_MODE_USER="test"
          export TEST_MODE_PASSWORD="test" TEST_MODE_DEVICE="/dev/loop0"
          export TEST_MODE_LUKS_PASSWORD="test"
          if ./install-arch.sh --test-mode --dry-run 2>&1 | grep -q "\[DRY-RUN\]"; then
            echo "✓ Dry-run and test-mode flags working correctly"
          else
            echo "✗ Flag handling test failed"
            exit 1
          fi


